#!/bin/bash

if [[ ${CONFIG_FILE_URL} ]];
then
    echo "Detected CONFIG_FILE_URL, Downloading..."
    curl -o config.env -s $CONFIG_FILE_URL && echo "Done"
else
    echo "CONFIG_FILE_URL var not provided!"
fi

if [[ -f config.env ]];
then
    echo "Loading... UPSTREAM_REPO and UPSTREAM_BRANCH from config.env"
    export $(echo "from dotenv import load_dotenv
    from os import environ

    load_dotenv('config.env', override=True)

    UPSTREAM_REPO = environ.get('UPSTREAM_REPO')
    UPSTREAM_BRANCH = environ.get('UPSTREAM_BRANCH')

    print(f'UPSTREAM_REPO={UPSTREAM_REPO}')
    print(f'UPSTREAM_BRANCH={UPSTREAM_BRANCH}')" | python3) && echo "Done"
else
    echo "Config.env file missing! Exiting now"
    exit
fi

if [[ ${UPSTREAM_REPO} && ${UPSTREAM_BRANCH} ]];
then
    echo "Detected UPSTREAM_REPO and UPSTREAM_BRANCH"
else
    UPSTREAM_REPO="https://github.com/ahad0xff/admlb"
    UPSTREAM_BRANCH="main"
    echo "UPSTREAM_REPO or UPSTREAM_BRANCH missing! Using default once"
fi

[ -d .git ] && rm -rf .git

git init -q
git config --global user.email ahadmirrorlab1@gmail.com
git config --global user.name ahadz-git
git add .
git commit -sm update -q
git remote add origin $UPSTREAM_REPO
git fetch origin -q
git reset --hard origin/$UPSTREAM_BRANCH -q

python3 -m bot
